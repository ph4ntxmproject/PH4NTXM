#!/usr/bin/env python3
import os
import sys
import subprocess
import gi
gi.require_version('Gtk', '3.0')
from gi.repository import Gtk, Gdk

def read_hostname():
    try:
        with open("/etc/hostname", "r", encoding="utf-8") as f:
            return f.read().strip()
    except Exception:
        return "unknown"

def read_machine_id():
    try:
        with open("/etc/machine-id", "r", encoding="utf-8") as f:
            return f.read().strip()
    except Exception:
        return "unknown"

def read_macs():
    macs = {}
    net_base = "/sys/class/net"
    try:
        for entry in sorted(os.listdir(net_base)):
            if entry == "lo":
                continue
            addr_path = os.path.join(net_base, entry, "address")
            try:
                with open(addr_path, "r", encoding="utf-8") as f:
                    mac = f.read().strip().lower()
                if mac and mac != "00:00:00:00:00:00":
                    macs[entry] = mac
            except Exception:
                continue
    except Exception:
        pass
    return macs

def gather_identity():
    return {
        "Hostname": read_hostname(),
        "Machine ID": read_machine_id(),
        "MACs": read_macs(),
        "Clock": "Fuzzed"
    }

def print_mode(info):
    print(f"Hostname: {info['Hostname']}")
    print(f"Machine ID: {info['Machine ID']}")
    macs = info["MACs"]
    if macs:
        for iface, mac in macs.items():
            print(f"{iface}: {mac}")
    else:
        print("MACs: none")
    print(f"Clock: {info['Clock']}")

class IdentityWindow(Gtk.Window):
    def __init__(self):
        Gtk.Window.__init__(self, title="Identity")
        self.set_border_width(20)
        self.set_resizable(False)
        self.set_default_size(420, 220)

        info = gather_identity()

        header = Gtk.Label()
        header.set_markup("<span size='12000' weight='bold'>Session Identity</span>")
        header.set_justify(Gtk.Justification.CENTER)

        vbox = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=12)
        self.add(vbox)
        vbox.pack_start(header, False, False, 0)

        sep = Gtk.Separator(orientation=Gtk.Orientation.HORIZONTAL)
        vbox.pack_start(sep, False, True, 0)

        grid = Gtk.Grid()
        grid.set_row_spacing(8)
        grid.set_column_spacing(12)
        vbox.pack_start(grid, True, True, 0)

        lbl_h = Gtk.Label(label="Hostname:")
        lbl_h.set_halign(Gtk.Align.START)

        val_h = Gtk.Label(label=info["Hostname"])
        val_h.set_halign(Gtk.Align.END)
        val_h.set_selectable(True)
        val_h.set_can_focus(False)

        grid.attach(lbl_h, 0, 0, 1, 1)
        grid.attach(val_h, 1, 0, 1, 1)

        lbl_m = Gtk.Label(label="Machine ID:")
        lbl_m.set_halign(Gtk.Align.START)

        mid = info["Machine ID"]
        display_mid = mid if len(mid) <= 40 else (mid[:36] + "â€¦")

        val_m = Gtk.Label(label=display_mid)
        val_m.set_halign(Gtk.Align.END)
        val_m.set_selectable(True)
        val_m.set_can_focus(False)

        grid.attach(lbl_m, 0, 1, 1, 1)
        grid.attach(val_m, 1, 1, 1, 1)

        lbl_mac = Gtk.Label(label="MAC Addresses:")
        lbl_mac.set_halign(Gtk.Align.START)

        macs = info["MACs"]
        mac_lines = "\n".join([f"{iface}: {mac}" for iface, mac in macs.items()]) if macs else "none"

        val_mac = Gtk.Label(label=mac_lines)
        val_mac.set_halign(Gtk.Align.END)
        val_mac.set_selectable(True)
        val_mac.set_can_focus(False)
        val_mac.set_justify(Gtk.Justification.RIGHT)
        val_mac.set_line_wrap(True)

        grid.attach(lbl_mac, 0, 2, 1, 1)
        grid.attach(val_mac, 1, 2, 1, 1)

        lbl_clock = Gtk.Label(label="Clock:")
        lbl_clock.set_halign(Gtk.Align.START)

        val_clock = Gtk.Label(label=info["Clock"])
        val_clock.set_halign(Gtk.Align.END)
        val_clock.set_can_focus(False)

        grid.attach(lbl_clock, 0, 3, 1, 1)
        grid.attach(val_clock, 1, 3, 1, 1)

        btn_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL)
        btn_box.set_halign(Gtk.Align.CENTER)
        vbox.pack_start(btn_box, False, False, 4)

        btn_close = Gtk.Button(label="Close")
        btn_close.set_size_request(120, 34)
        btn_close.connect("clicked", lambda w: self.close())
        btn_box.pack_start(btn_close, False, False, 0)

        self.connect("destroy", Gtk.main_quit)

def main():
    if len(sys.argv) > 1 and sys.argv[1] in ("--print", "-p"):
        info = gather_identity()
        print_mode(info)
        return

    win = IdentityWindow()
    win.show_all()
    Gtk.main()

if __name__ == "__main__":
    main()
